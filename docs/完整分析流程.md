# æˆ¶æ”¿å¸é–€ç‰ŒæŸ¥è©¢çˆ¬èŸ² - å®Œæ•´åˆ†ææµç¨‹

## ç›®éŒ„
1. [å¾é›¶é–‹å§‹çš„åˆ†ææµç¨‹](#å¾é›¶é–‹å§‹çš„åˆ†ææµç¨‹)
2. [é€æ­¥æ¸¬è©¦ Requests](#é€æ­¥æ¸¬è©¦-requests)
3. [Postman æ¸¬è©¦æŒ‡å—](#postman-æ¸¬è©¦æŒ‡å—)
4. [å®Œæ•´ç¨‹å¼ç¢¼](#å®Œæ•´ç¨‹å¼ç¢¼)

---

## å¾é›¶é–‹å§‹çš„åˆ†ææµç¨‹

### éšæ®µ 0ï¼šåˆå§‹è§€å¯Ÿ

**ç›®æ¨™ç¶²å€**: https://www.ris.gov.tw/app/portal/3053

#### æ­¥é©Ÿ 1ï¼šæª¢è¦–é é¢çµæ§‹
1. æ‰“é–‹ç¶²å€
2. F12 â†’ Elements æ¨™ç±¤
3. ç™¼ç¾ä¸»é é¢åªæœ‰ä¸€å€‹ `<iframe>`ï¼š
   ```html
   <iframe src="/info-doorplate/app/doorplate/main" ...>
   ```

**çµè«–**: çœŸæ­£çš„å…§å®¹åœ¨ `/info-doorplate/app/doorplate/main`

---

### éšæ®µ 1ï¼šè§€å¯Ÿå°èˆªæµç¨‹

#### æ­¥é©Ÿ 1ï¼šé–‹å•Ÿ Network ç›£æ§
1. F12 â†’ Network æ¨™ç±¤
2. **å‹¾é¸ "Preserve log"**ï¼ˆé‡è¦ï¼ï¼‰
3. é»æ“Šå·¦ä¸Šè§’ ğŸš« æ¸…ç©ºè¨˜éŒ„

#### æ­¥é©Ÿ 2ï¼šå¯¦éš›æ“ä½œç¶²ç«™ä¸¦è§€å¯Ÿè«‹æ±‚
```
æ“ä½œ                              â†’ Network ä¸­å‡ºç¾çš„è«‹æ±‚
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
1. é»æ“Šã€Œä»¥ç·¨é‡˜æ—¥æœŸã€ç·¨é‡˜é¡åˆ¥æŸ¥è©¢ã€ â†’ POST /info-doorplate/app/doorplate/map
2. é»æ“Šåœ°åœ–ä¸Šçš„ã€Œå°åŒ—å¸‚ã€           â†’ POST /info-doorplate/app/doorplate/query
3. å¡«å¯«è¡¨å–®ï¼Œè¼¸å…¥é©—è­‰ç¢¼ï¼Œé»ã€Œæœå°‹ã€  â†’ POST /info-doorplate/app/doorplate/inquiry/date
```

#### æ­¥é©Ÿ 3ï¼šåˆ†ææ¯å€‹è«‹æ±‚

**è«‹æ±‚ 1: map**
- é»æ“Šè«‹æ±‚ â†’ Headers æ¨™ç±¤
- å‘ä¸‹æ²å‹•æ‰¾åˆ° "Form Data" æˆ–åˆ‡æ›åˆ° "Payload" æ¨™ç±¤
- çœ‹åˆ°åƒæ•¸ï¼š
  ```
  _csrf: xxx-xxx-xxx
  searchType: date
  ```

**è«‹æ±‚ 2: query**
- åŒæ¨£æŸ¥çœ‹ Payload
- çœ‹åˆ°åƒæ•¸ï¼š
  ```
  _csrf: xxx-xxx-xxx
  searchType: date
  cityCode: 63000000
  ```

**è«‹æ±‚ 3: dateï¼ˆè³‡æ–™ APIï¼ï¼‰**
- åˆ‡æ›åˆ° "Response" æ¨™ç±¤
- çœ‹åˆ° JSON æ ¼å¼çš„è³‡æ–™ï¼š
  ```json
  {
    "records": 246,
    "rows": [
      {"v1": "è‡ºåŒ—å¸‚æ¾å±±å€...", "v2": "æ°‘åœ‹114å¹´10æœˆ29æ—¥", "v3": "1"},
      ...
    ]
  }
  ```

**é—œéµç™¼ç¾**: 
- è³‡æ–™æ˜¯ JSON æ ¼å¼ï¼Œä¸æ˜¯ HTMLï¼
- ä¸éœ€è¦ BeautifulSoup è§£æ HTML
- ç›´æ¥å‘¼å« API å³å¯

---

### éšæ®µ 2ï¼šæ‰¾å‡ºéš±è—åƒæ•¸

#### å•é¡Œï¼š`_csrf` å’Œ `captchaKey` å¾å“ªä¾†ï¼Ÿ

#### æ­¥é©Ÿ 1ï¼šæŠ“å– HTML åˆ†æ
```python
import requests

resp = requests.get("https://www.ris.gov.tw/info-doorplate/app/doorplate/query")
with open("query_page.html", "w", encoding="utf-8") as f:
    f.write(resp.text)
```

#### æ­¥é©Ÿ 2ï¼šæœå°‹éš±è—æ¬„ä½
åœ¨ `query_page.html` ä¸­æœå°‹ `type="hidden"`ï¼š

```html
<input type="hidden" name="_csrf" value="3297ed3c-ab02-4c89-a...">
<input type="hidden" id="captchaKey_captchaKey" value="b949d1a524b149f0...">
```

#### æ­¥é©Ÿ 3ï¼šç”¨ Regex æå–
```python
import re

csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
captcha_key = re.search(r'id="captchaKey_captchaKey"\s+value="([^"]+)"', resp.text).group(1)
```

---

### éšæ®µ 3ï¼šåˆ†æå®Œæ•´åƒæ•¸åˆ—è¡¨

#### æ­¥é©Ÿ 1ï¼šåœ¨ F12 ä¸­æ‰¾åˆ°æˆåŠŸçš„è«‹æ±‚
- Network â†’ æ‰¾åˆ° `date` è«‹æ±‚
- Payload æ¨™ç±¤ â†’ çœ‹åˆ° 25 å€‹åƒæ•¸

#### æ­¥é©Ÿ 2ï¼šè¨˜éŒ„æ‰€æœ‰åƒæ•¸
```
å¿…å¡«åƒæ•¸:
  searchType: date
  cityCode: 63000000
  areaCode: 63000010
  sDate: 114-09-01        â† æ³¨æ„ï¼šç”¨ç ´æŠ˜è™Ÿï¼
  eDate: 114-11-30
  registerKind: 1
  captchaInput: ABC12
  captchaKey: xxx
  _csrf: xxx

ç©ºå€¼åƒæ•¸ï¼ˆä¹Ÿè¦å‚³ï¼ï¼‰:
  village: 
  neighbor: 
  floor: 
  lane: 
  alley: 
  number: 
  number1: 
  ext: 

jqGrid åˆ†é åƒæ•¸:
  _search: false
  nd: 1736226789123      â† æ™‚é–“æˆ³è¨˜
  rows: 50
  page: 1
  sidx: 
  sord: asc
  tkt: -1
  _includeNoDate: on
```

#### æ­¥é©Ÿ 3ï¼šæ¸¬è©¦å“ªäº›åƒæ•¸æ˜¯å¿…è¦çš„
é€éé€ä¸€ç§»é™¤åƒæ•¸æ¸¬è©¦ï¼Œç™¼ç¾ï¼š
- **æ‰€æœ‰åƒæ•¸éƒ½è¦å‚³**ï¼ˆåŒ…æ‹¬ç©ºå€¼ï¼‰
- ç¼ºå°‘ä»»ä½•ä¸€å€‹éƒ½æœƒå¤±æ•—

---

## é€æ­¥æ¸¬è©¦ Requests

### æ¸¬è©¦ 1ï¼šè¨ªå•ä¸»é é¢

**ç›®æ¨™**: å–å¾—åˆå§‹çš„ `_csrf` token

```python
import requests
import re

BASE_URL = "https://www.ris.gov.tw"
session = requests.Session()
session.headers.update({
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
})

# Step 1: è¨ªå•ä¸»é é¢
resp = session.get(f"{BASE_URL}/info-doorplate/app/doorplate/main")
csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)

print(f"âœ“ å–å¾— CSRF token: {csrf[:30]}...")
```

**æ¸¬è©¦çµæœ**: 
```
âœ“ å–å¾— CSRF token: 74eeb05b-2e60-4d92-b48b-35e410...
```

---

### æ¸¬è©¦ 2ï¼šé€²å…¥åœ°åœ–é é¢

**ç›®æ¨™**: æ¨¡æ“¬é»æ“Šã€Œä»¥ç·¨é‡˜æ—¥æœŸæŸ¥è©¢ã€

```python
# Step 2: POST åˆ° map
resp = session.post(
    f"{BASE_URL}/info-doorplate/app/doorplate/map",
    data={
        "_csrf": csrf,
        "searchType": "date"
    }
)

# æ›´æ–° CSRF tokenï¼ˆæ¯æ¬¡å›æ‡‰éƒ½æœƒçµ¦æ–°çš„ï¼‰
csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)

print(f"âœ“ é€²å…¥åœ°åœ–é é¢")
print(f"âœ“ æ–° CSRF token: {csrf[:30]}...")
```

**æ¸¬è©¦çµæœ**:
```
âœ“ é€²å…¥åœ°åœ–é é¢
âœ“ æ–° CSRF token: 74eeb05b-2e60-4d92-b48b-35e410...
```

---

### æ¸¬è©¦ 3ï¼šé¸æ“‡ç¸£å¸‚

**ç›®æ¨™**: æ¨¡æ“¬é»æ“Šã€Œå°åŒ—å¸‚ã€

```python
# Step 3: POST åˆ° query
resp = session.post(
    f"{BASE_URL}/info-doorplate/app/doorplate/query",
    data={
        "_csrf": csrf,
        "searchType": "date",
        "cityCode": "63000000"  # å°åŒ—å¸‚
    }
)

# æå–å¿…è¦è³‡è¨Š
csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
captcha_key = re.search(r'id="captchaKey_captchaKey"\s+value="([^"]+)"', resp.text).group(1)

print(f"âœ“ é€²å…¥æŸ¥è©¢é é¢")
print(f"âœ“ CSRF token: {csrf[:30]}...")
print(f"âœ“ Captcha Key: {captcha_key}")
```

**æ¸¬è©¦çµæœ**:
```
âœ“ é€²å…¥æŸ¥è©¢é é¢
âœ“ CSRF token: 74eeb05b-2e60-4d92-b48b-35e410...
âœ“ Captcha Key: ddcae9a4461f49309a4ee8c65099ffc2
```

---

### æ¸¬è©¦ 4ï¼šå–å¾—é©—è­‰ç¢¼

**ç›®æ¨™**: ä¸‹è¼‰é©—è­‰ç¢¼åœ–ç‰‡

```python
import time

# Step 4: å–å¾—é©—è­‰ç¢¼åœ–ç‰‡
timestamp = int(time.time() * 1000)
captcha_url = f"{BASE_URL}/info-doorplate/captcha/image?CAPTCHA_KEY={captcha_key}&time={timestamp}"

resp = session.get(captcha_url)
with open("captcha.png", "wb") as f:
    f.write(resp.content)

print(f"âœ“ é©—è­‰ç¢¼å·²å„²å­˜: captcha.png ({len(resp.content)} bytes)")
```

**æ¸¬è©¦çµæœ**:
```
âœ“ é©—è­‰ç¢¼å·²å„²å­˜: captcha.png (1655 bytes)
```

---

### æ¸¬è©¦ 5ï¼šæŸ¥è©¢è³‡æ–™ï¼ˆæœ€é—œéµï¼ï¼‰

**ç›®æ¨™**: æäº¤å®Œæ•´åƒæ•¸å–å¾—è³‡æ–™

```python
import json

# Step 5: æ‰‹å‹•è¼¸å…¥é©—è­‰ç¢¼
captcha_input = input("è«‹è¼¸å…¥é©—è­‰ç¢¼: ").strip()

# æº–å‚™å®Œæ•´åƒæ•¸
nd = int(time.time() * 1000)

post_data = {
    "searchType": "date",
    "cityCode": "63000000",
    "tkt": "-1",
    "areaCode": "63000010",      # æ¾å±±å€
    "village": "",
    "neighbor": "",
    "sDate": "114-09-01",        # â† é‡é»ï¼šç”¨ç ´æŠ˜è™Ÿï¼
    "eDate": "114-11-30",
    "_includeNoDate": "on",
    "registerKind": "1",
    "captchaInput": captcha_input,
    "captchaKey": captcha_key,
    "_csrf": csrf,
    "floor": "",
    "lane": "",
    "alley": "",
    "number": "",
    "number1": "",
    "ext": "",
    "_search": "false",
    "nd": str(nd),
    "rows": "50",
    "page": "1",
    "sidx": "",
    "sord": "asc",
}

# è¨­å®š Headersï¼ˆé‡è¦ï¼ï¼‰
headers = {
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
    "X-Requested-With": "XMLHttpRequest",
    "X-CSRF-TOKEN": csrf,
    "Referer": f"{BASE_URL}/info-doorplate/app/doorplate/query",
}

# ç™¼é€è«‹æ±‚
resp = session.post(
    f"{BASE_URL}/info-doorplate/app/doorplate/inquiry/date",
    data=post_data,
    headers=headers
)

# è§£æçµæœ
result = resp.json()
print(json.dumps(result, ensure_ascii=False, indent=2))
```

**æ¸¬è©¦çµæœ**:
```json
{
  "errorMsg": "",
  "total": 5,
  "page": 1,
  "records": 246,
  "rows": [
    {
      "v1": "è‡ºåŒ—å¸‚æ¾å±±å€æ…ˆç¥é‡Œ014é„°å…«å¾·è·¯å››æ®µï¼”ï¼˜ï¼–è™Ÿ",
      "v2": "æ°‘åœ‹114å¹´10æœˆ29æ—¥",
      "v3": "1"
    },
    ...
  ]
}
```

âœ“ **æˆåŠŸå–å¾— 246 ç­†è³‡æ–™ï¼**

---

## Postman æ¸¬è©¦æŒ‡å—

### æ˜¯çš„ï¼Œä½ å¯ä»¥åœ¨ Postman ä¸­æ‰‹å‹•æ¸¬è©¦ï¼

ä½†æœ‰å¹¾å€‹é‡é»è¦æ³¨æ„ï¼š

### é‡é» 1ï¼šå¿…é ˆæŒ‰é †åºåŸ·è¡Œ

```
Request 1 â†’ å–å¾— csrf_token_1
    â†“
Request 2 â†’ ä½¿ç”¨ csrf_token_1ï¼Œå–å¾— csrf_token_2
    â†“
Request 3 â†’ ä½¿ç”¨ csrf_token_2ï¼Œå–å¾— csrf_token_3 å’Œ captcha_key
    â†“
Request 4 â†’ ä½¿ç”¨ csrf_token_3 å’Œ captcha_key æŸ¥è©¢è³‡æ–™
```

**ä¸èƒ½è·³éä»»ä½•ä¸€æ­¥ï¼** CSRF token æœƒåœ¨æ¯æ¬¡è«‹æ±‚å¾Œæ›´æ–°ã€‚

---

### é‡é» 2ï¼šéœ€è¦ç¶­æŒ Sessionï¼ˆCookiesï¼‰

åœ¨ Postman ä¸­ï¼š
1. è¨­å®š â†’ Settings â†’ Cookies
2. ç¢ºä¿ "Automatically follow redirects" é–‹å•Ÿ
3. ä½¿ç”¨åŒä¸€å€‹ Tab åŸ·è¡Œæ‰€æœ‰è«‹æ±‚ï¼ˆé€™æ¨£ Cookies æœƒè‡ªå‹•ä¿ç•™ï¼‰

---

### Postman è«‹æ±‚è¨­å®š

#### Request 1: å–å¾—åˆå§‹ Token

```
Method: GET
URL: https://www.ris.gov.tw/info-doorplate/app/doorplate/main

Headers:
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

Response:
  å¾ HTML ä¸­è¤‡è£½ _csrf çš„ value
```

#### Request 2: é€²å…¥åœ°åœ–é 

```
Method: POST
URL: https://www.ris.gov.tw/info-doorplate/app/doorplate/map

Headers:
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
  Content-Type: application/x-www-form-urlencoded

Body (x-www-form-urlencoded):
  _csrf: [å¾ Request 1 è¤‡è£½]
  searchType: date

Response:
  å¾ HTML ä¸­è¤‡è£½æ–°çš„ _csrf çš„ value
```

#### Request 3: é¸æ“‡ç¸£å¸‚

```
Method: POST
URL: https://www.ris.gov.tw/info-doorplate/app/doorplate/query

Headers:
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
  Content-Type: application/x-www-form-urlencoded

Body (x-www-form-urlencoded):
  _csrf: [å¾ Request 2 è¤‡è£½]
  searchType: date
  cityCode: 63000000

Response:
  å¾ HTML ä¸­è¤‡è£½:
  - æ–°çš„ _csrf çš„ value
  - captchaKey çš„ value (åœ¨ id="captchaKey_captchaKey" çš„ input)
```

#### Request 4: å–å¾—é©—è­‰ç¢¼åœ–ç‰‡

```
Method: GET
URL: https://www.ris.gov.tw/info-doorplate/captcha/image?CAPTCHA_KEY=[å¾ Request 3 è¤‡è£½]&time=1736226789123

Headers:
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36

Response:
  Save Response â†’ Save to a file â†’ captcha.png
  æ‰‹å‹•æŸ¥çœ‹åœ–ç‰‡ä¸¦è¨˜ä¸‹é©—è­‰ç¢¼
```

#### Request 5: æŸ¥è©¢è³‡æ–™

```
Method: POST
URL: https://www.ris.gov.tw/info-doorplate/app/doorplate/inquiry/date

Headers:
  User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
  Accept: application/json, text/javascript, */*; q=0.01
  Content-Type: application/x-www-form-urlencoded; charset=UTF-8
  X-Requested-With: XMLHttpRequest
  X-CSRF-TOKEN: [å¾ Request 3 è¤‡è£½]
  Referer: https://www.ris.gov.tw/info-doorplate/app/doorplate/query

Body (x-www-form-urlencoded):
  searchType: date
  cityCode: 63000000
  tkt: -1
  areaCode: 63000010
  village: 
  neighbor: 
  sDate: 114-09-01
  eDate: 114-11-30
  _includeNoDate: on
  registerKind: 1
  captchaInput: [æ‰‹å‹•è¼¸å…¥é©—è­‰ç¢¼]
  captchaKey: [å¾ Request 3 è¤‡è£½]
  _csrf: [å¾ Request 3 è¤‡è£½]
  floor: 
  lane: 
  alley: 
  number: 
  number1: 
  ext: 
  _search: false
  nd: 1736226789123
  rows: 50
  page: 1
  sidx: 
  sord: asc

Response:
  æœƒçœ‹åˆ° JSON æ ¼å¼çš„è³‡æ–™ï¼
```

---

### Postman å¸¸è¦‹å•é¡Œ

**Q1: ç‚ºä»€éº¼æˆ‘çš„è«‹æ±‚å¤±æ•—ï¼Ÿ**
- ç¢ºèªæ˜¯å¦æŒ‰é †åºåŸ·è¡Œ
- ç¢ºèª CSRF token æ˜¯æœ€æ–°çš„ï¼ˆæ¯æ¬¡è«‹æ±‚å¾Œéƒ½è¦æ›´æ–°ï¼‰
- ç¢ºèª Cookies æœ‰ä¿ç•™ï¼ˆä½¿ç”¨åŒä¸€å€‹ Tabï¼‰

**Q2: ç©ºå€¼åƒæ•¸è¦æ€éº¼è¨­å®šï¼Ÿ**
- åœ¨ Postman çš„ Body ä¸­ï¼ŒKey å¡«åƒæ•¸åç¨±ï¼ŒValue ç•™ç©ºå³å¯

**Q3: é©—è­‰ç¢¼è¼¸å…¥éŒ¯èª¤æ€éº¼è¾¦ï¼Ÿ**
- éœ€è¦é‡æ–°å¾ Request 3 é–‹å§‹ï¼ˆå–å¾—æ–°çš„ captcha_keyï¼‰

---

## å®Œæ•´ç¨‹å¼ç¢¼

### æ–¹æ³• 1ï¼šé€æ­¥åŸ·è¡Œï¼ˆæ•™å­¸ç”¨ï¼‰

```python
"""
é€æ­¥æ¸¬è©¦ç‰ˆæœ¬ - æ¯ä¸€æ­¥éƒ½é¡¯ç¤ºçµæœ
"""
import requests
import re
import time
import json

BASE_URL = "https://www.ris.gov.tw"

# å»ºç«‹ Session
session = requests.Session()
session.headers.update({
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
})

print("=" * 60)
print("æˆ¶æ”¿å¸é–€ç‰ŒæŸ¥è©¢ - é€æ­¥æ¸¬è©¦")
print("=" * 60)

# ============================================================
# Step 1: è¨ªå•ä¸»é é¢
# ============================================================
print("\n[Step 1] è¨ªå•ä¸»é é¢...")
resp = session.get(f"{BASE_URL}/info-doorplate/app/doorplate/main")
csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
print(f"âœ“ CSRF token: {csrf[:30]}...")

# ============================================================
# Step 2: é€²å…¥åœ°åœ–é é¢
# ============================================================
print("\n[Step 2] é€²å…¥åœ°åœ–é é¢...")
resp = session.post(
    f"{BASE_URL}/info-doorplate/app/doorplate/map",
    data={"_csrf": csrf, "searchType": "date"}
)
csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
print(f"âœ“ æ–° CSRF token: {csrf[:30]}...")

# ============================================================
# Step 3: é¸æ“‡å°åŒ—å¸‚
# ============================================================
print("\n[Step 3] é¸æ“‡å°åŒ—å¸‚...")
resp = session.post(
    f"{BASE_URL}/info-doorplate/app/doorplate/query",
    data={"_csrf": csrf, "searchType": "date", "cityCode": "63000000"}
)
csrf = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
captcha_key = re.search(r'id="captchaKey_captchaKey"\s+value="([^"]+)"', resp.text).group(1)
print(f"âœ“ CSRF token: {csrf[:30]}...")
print(f"âœ“ Captcha Key: {captcha_key}")

# ============================================================
# Step 4: å–å¾—é©—è­‰ç¢¼
# ============================================================
print("\n[Step 4] å–å¾—é©—è­‰ç¢¼...")
timestamp = int(time.time() * 1000)
captcha_url = f"{BASE_URL}/info-doorplate/captcha/image?CAPTCHA_KEY={captcha_key}&time={timestamp}"
resp = session.get(captcha_url)
with open("captcha.png", "wb") as f:
    f.write(resp.content)
print(f"âœ“ å·²å„²å­˜ captcha.png ({len(resp.content)} bytes)")

# ============================================================
# Step 5: è¼¸å…¥é©—è­‰ç¢¼ä¸¦æŸ¥è©¢
# ============================================================
print("\n" + "-" * 60)
captcha_input = input("è«‹è¼¸å…¥é©—è­‰ç¢¼: ").strip()

print("\n[Step 5] æŸ¥è©¢è³‡æ–™...")
nd = int(time.time() * 1000)

post_data = {
    "searchType": "date",
    "cityCode": "63000000",
    "tkt": "-1",
    "areaCode": "63000010",
    "village": "",
    "neighbor": "",
    "sDate": "114-09-01",
    "eDate": "114-11-30",
    "_includeNoDate": "on",
    "registerKind": "1",
    "captchaInput": captcha_input,
    "captchaKey": captcha_key,
    "_csrf": csrf,
    "floor": "",
    "lane": "",
    "alley": "",
    "number": "",
    "number1": "",
    "ext": "",
    "_search": "false",
    "nd": str(nd),
    "rows": "50",
    "page": "1",
    "sidx": "",
    "sord": "asc",
}

headers = {
    "Accept": "application/json, text/javascript, */*; q=0.01",
    "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
    "X-Requested-With": "XMLHttpRequest",
    "X-CSRF-TOKEN": csrf,
    "Referer": f"{BASE_URL}/info-doorplate/app/doorplate/query",
}

resp = session.post(
    f"{BASE_URL}/info-doorplate/app/doorplate/inquiry/date",
    data=post_data,
    headers=headers
)

result = resp.json()

# ============================================================
# é¡¯ç¤ºçµæœ
# ============================================================
print("\n" + "=" * 60)
print("æŸ¥è©¢çµæœ")
print("=" * 60)

if result.get("records", 0) > 0:
    print(f"âœ“ æˆåŠŸï¼æ‰¾åˆ° {result['records']} ç­†è³‡æ–™")
    print(f"\nå‰ 5 ç­†:")
    for i, row in enumerate(result['rows'][:5]):
        print(f"  {i+1}. {row['v1']}")
        print(f"     æ—¥æœŸ: {row['v2']}")
        print(f"     é¡åˆ¥: {row['v3']}")
else:
    print("æŸ¥ç„¡è³‡æ–™æˆ–ç™¼ç”ŸéŒ¯èª¤")
    print(json.dumps(result, ensure_ascii=False, indent=2))
```

---

### æ–¹æ³• 2ï¼šå°è£ç‰ˆï¼ˆå¯¦éš›ä½¿ç”¨ï¼‰

é€™å°±æ˜¯æˆ‘å€‘çš„ `crawler_requests.py`ï¼š

```python
"""
æˆ¶æ”¿å¸é–€ç‰ŒæŸ¥è©¢çˆ¬èŸ² - å°è£ç‰ˆ
"""
import requests
import re
import time
from dataclasses import dataclass, field
from typing import List, Dict

@dataclass
class QueryResult:
    success: bool
    data: List[Dict] = field(default_factory=list)
    total_count: int = 0
    error_message: str = ""

class HouseholdCrawler:
    BASE_URL = "https://www.ris.gov.tw"
    
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/143.0.0.0 Safari/537.36",
        })
        self.csrf_token = ""
        self.captcha_key = ""
        self.city_code = ""
    
    def init_session(self, city_code: str = "63000000") -> bool:
        """åˆå§‹åŒ– sessionï¼Œå®Œæˆä¸‰æ­¥å°èˆª"""
        try:
            # Step 1: ä¸»é é¢
            resp = self.session.get(f"{self.BASE_URL}/info-doorplate/app/doorplate/main")
            self.csrf_token = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
            
            # Step 2: åœ°åœ–é 
            resp = self.session.post(
                f"{self.BASE_URL}/info-doorplate/app/doorplate/map",
                data={"_csrf": self.csrf_token, "searchType": "date"}
            )
            self.csrf_token = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
            
            # Step 3: æŸ¥è©¢é 
            resp = self.session.post(
                f"{self.BASE_URL}/info-doorplate/app/doorplate/query",
                data={"_csrf": self.csrf_token, "searchType": "date", "cityCode": city_code}
            )
            
            self.csrf_token = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text).group(1)
            self.captcha_key = re.search(r'id="captchaKey_captchaKey"\s+value="([^"]+)"', resp.text).group(1)
            self.city_code = city_code
            return True
        except:
            return False
    
    def get_captcha(self, save_path: str = "captcha.png") -> bool:
        """å–å¾—é©—è­‰ç¢¼åœ–ç‰‡"""
        try:
            ts = int(time.time() * 1000)
            url = f"{self.BASE_URL}/info-doorplate/captcha/image?CAPTCHA_KEY={self.captcha_key}&time={ts}"
            resp = self.session.get(url)
            
            if resp.status_code == 200:
                with open(save_path, "wb") as f:
                    f.write(resp.content)
                return True
            return False
        except:
            return False
    
    def query(self, area_code: str, start_date: str, end_date: str, 
              captcha_input: str, register_kind: str = "1") -> QueryResult:
        """åŸ·è¡ŒæŸ¥è©¢"""
        try:
            nd = int(time.time() * 1000)
            
            post_data = {
                "searchType": "date",
                "cityCode": self.city_code,
                "tkt": "-1",
                "areaCode": area_code,
                "village": "",
                "neighbor": "",
                "sDate": start_date,
                "eDate": end_date,
                "_includeNoDate": "on",
                "registerKind": register_kind,
                "captchaInput": captcha_input,
                "captchaKey": self.captcha_key,
                "_csrf": self.csrf_token,
                "floor": "",
                "lane": "",
                "alley": "",
                "number": "",
                "number1": "",
                "ext": "",
                "_search": "false",
                "nd": str(nd),
                "rows": "50",
                "page": "1",
                "sidx": "",
                "sord": "asc",
            }
            
            headers = {
                "Accept": "application/json, text/javascript, */*; q=0.01",
                "Content-Type": "application/x-www-form-urlencoded; charset=UTF-8",
                "X-Requested-With": "XMLHttpRequest",
                "X-CSRF-TOKEN": self.csrf_token,
                "Referer": f"{self.BASE_URL}/info-doorplate/app/doorplate/query",
            }
            
            resp = self.session.post(
                f"{self.BASE_URL}/info-doorplate/app/doorplate/inquiry/date",
                data=post_data,
                headers=headers
            )
            
            result = resp.json()
            records = result.get("records", 0)
            rows_data = result.get("rows", [])
            
            if records > 0 or rows_data:
                data = [{"address": r.get("v1", ""), "date": r.get("v2", ""), "type": r.get("v3", "")} 
                        for r in rows_data]
                return QueryResult(success=True, data=data, total_count=records)
            
            return QueryResult(success=False, error_message="æŸ¥ç„¡è³‡æ–™")
            
        except Exception as e:
            return QueryResult(success=False, error_message=str(e))

# ä½¿ç”¨ç¯„ä¾‹
if __name__ == "__main__":
    crawler = HouseholdCrawler()
    
    if crawler.init_session("63000000"):
        crawler.get_captcha("captcha.png")
        captcha = input("è«‹è¼¸å…¥é©—è­‰ç¢¼: ")
        
        result = crawler.query(
            area_code="63000010",
            start_date="114-09-01",
            end_date="114-11-30",
            captcha_input=captcha
        )
        
        if result.success:
            print(f"æ‰¾åˆ° {result.total_count} ç­†è³‡æ–™")
```

---

## é—œéµé‡é»ç¸½çµ

### 1. æ—¥æœŸæ ¼å¼
```python
âœ“ æ­£ç¢º: "114-09-01"  (ç ´æŠ˜è™Ÿ)
âœ— éŒ¯èª¤: "114/09/01"  (æ–œç·š)
```

### 2. åƒæ•¸å®Œæ•´æ€§
æ‰€æœ‰ 25 å€‹åƒæ•¸éƒ½è¦å‚³ï¼ŒåŒ…æ‹¬ç©ºå€¼åƒæ•¸

### 3. CSRF Token æ›´æ–°
æ¯æ¬¡è«‹æ±‚å¾Œéƒ½è¦å¾å›æ‡‰ä¸­æå–æ–°çš„ token

### 4. Session ç¶­æŒ
ä½¿ç”¨ `requests.Session()` ä¿æŒ Cookies

### 5. Headers è¨­å®š
å¿…é ˆåŒ…å« `X-CSRF-TOKEN` å’Œ `X-Requested-With`

---

## é™¤éŒ¯æŠ€å·§

### å•é¡Œ 1ï¼šé©—è­‰ç¢¼éŒ¯èª¤
- ç¢ºèªé©—è­‰ç¢¼æ²’æœ‰éæœŸï¼ˆå–å¾—å¾Œç«‹å³ä½¿ç”¨ï¼‰
- æ³¨æ„å¤§å°å¯«

### å•é¡Œ 2ï¼šæŸ¥ç„¡è³‡æ–™
- æª¢æŸ¥æ—¥æœŸæ ¼å¼ï¼ˆç ´æŠ˜è™Ÿï¼‰
- ç¢ºèªå€åŸŸä»£ç¢¼æ­£ç¢º

### å•é¡Œ 3ï¼šè«‹æ±‚å¤±æ•—
- æª¢æŸ¥ CSRF token æ˜¯å¦æœ€æ–°
- ç¢ºèªæ‰€æœ‰åƒæ•¸éƒ½æœ‰å‚³
- æª¢æŸ¥ Headers è¨­å®š

---

**å®Œæˆï¼ä½ ç¾åœ¨å®Œå…¨äº†è§£æ•´å€‹åˆ†æå’Œå¯¦ä½œæµç¨‹äº†ã€‚**
